<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>マイページ</title>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/date-fns@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

<style>

:root{
  --primary:#00c4d6;          
  --primary-dark:#009eae;
  --sidebar-bg:#f1f3f4;
  --text-main:#333;
  --header-h:60px;            
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:"Segoe UI","Noto Sans JP",sans-serif;
  color:var(--text-main);
  background:#fafafa;
}

header{
  position:fixed;top:0;left:0;right:0;
  height:var(--header-h);
  background:var(--primary);
  display:flex;align-items:center;
  padding:0 20px;
  z-index:100;
}
header h2{
  margin-left:48px;
  font-size:1.25rem;
  color:#fff;
}
.menu-icon{
  width:30px;height:30px;
  cursor:pointer;
}

.menu-icon img, .menu-icon svg{width:100%;height:100%}

.sidebar{
  position:fixed;top:var(--header-h);left:0;height:calc(100% - var(--header-h));
  width:220px;
  background:var(--sidebar-bg);
  padding-top:20px;
  transform:translateX(-100%);
  transition:transform .3s ease;
  display:flex;flex-direction:column;gap:8px;
}
.sidebar.open{transform:translateX(0)}
.sidebar a{
  padding:12px 20px;
  text-decoration:none;
  color:var(--text-main);
  transition:background .2s;
}
.sidebar a:hover{
  background:rgba(0,0,0,.06);
}

main{
  padding-top:calc(var(--header-h) + 20px);
  padding-left:20px;padding-right:20px;
  max-width:1000px;margin:auto;
}
.center-content{text-align:center;margin-bottom:24px}

.period-toggle{
  text-align:center;margin-bottom:16px;
}
.period-button{
  border:1px solid var(--primary);
  background:#fff;
  color:var(--primary-dark);
  padding:6px 18px;
  border-radius:20px;
  cursor:pointer;
  margin:0 4px;
  transition:all .2s;
}
.period-button.active,
.period-button:hover{
  background:var(--primary);
  color:#fff;
}

.chart-wrapper{
  width:100%;
  max-width:800px;
  height:450px;
  margin:0 auto 40px auto;
}

@media(max-width:600px){
  .chart-wrapper{height:320px}
  header h2{font-size:1rem}
}
</style>
</head>

<body>

<header>
  <div class="menu-icon" id="menuBtn">
    <svg viewBox="0 0 24 24"><path d="M3 6h18M3 12h18M3 18h18" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
  </div>
  <h2>マイページ</h2>
</header>
<nav class="sidebar" id="sidebar">
  <a th:href="@{/editProfile}">ユーザー情報編集</a>
  <a th:href="@{/weightInput}">体重入力</a>
  <a th:href="@{/logout}">ログアウト</a>
</nav>
<main>
  <div class="center-content">
    <h1>こんにちは、<span th:text="${account != null ? account.username : 'ゲスト'}">ユーザー名</span>さん</h1>
  </div>
  <div class="period-toggle">
    <button class="period-button active" data-period="WEEK">1週間</button>
    <button class="period-button" data-period="MONTH">1か月</button>
    <button class="period-button" data-period="YEAR">1年</button>
  </div>
  <div class="chart-wrapper">
    <canvas id="weightChart"></canvas>
  </div>
</main>

<script>
document.getElementById('menuBtn').addEventListener('click',()=>{
  document.getElementById('sidebar').classList.toggle('open');
});

let chart;
const unitMap={WEEK:'day',MONTH:'day',YEAR:'month'};

function toggleActiveButton(period){
  document.querySelectorAll('.period-button').forEach(btn=>{
    btn.classList.toggle('active',btn.dataset.period===period);
  });
}

async function loadChart(period){
  toggleActiveButton(period);
  try{
    const res=await fetch(`/chart-data?period=${period}`);
    if(!res.ok) throw new Error('データ取得失敗');
    const data=await res.json();
    const labels=data.map(d=>d.period);
    const values=data.map(d=>d.weight);

    if(chart) chart.destroy();
    const ctx=document.getElementById('weightChart').getContext('2d');
    const gradient=ctx.createLinearGradient(0,0,0,450);
    gradient.addColorStop(0,'rgba(0,196,214,.35)');
    gradient.addColorStop(1,'rgba(0,196,214,0)');

    chart=new Chart(ctx,{
      type:'line',
      data:{
        labels,
        datasets:[{
          label:'平均体重 (kg)',
          data:values,
          borderColor:'var(--primary)',
          backgroundColor:gradient,
          tension:.35,
          fill:true,
          pointRadius:3
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        scales:{
          x:{type:'time',time:{unit:unitMap[period],tooltipFormat:period==='YEAR'?'yyyy-MM':'yyyy-MM-dd'},grid:{display:false}},
          y:{beginAtZero:false,grid:{borderDash:[4,4]},title:{display:true,text:'体重 (kg)'}}
        },
        plugins:{legend:{display:false}}
      }
    });
  }catch(e){
    console.error(e);
    alert('グラフの読み込みに失敗しました');
  }
}

document.querySelectorAll('.period-button').forEach(btn=>{
  btn.addEventListener('click',()=>loadChart(btn.dataset.period));
});

window.addEventListener('DOMContentLoaded',()=>loadChart('WEEK'));
</script>
</body>
</html>
